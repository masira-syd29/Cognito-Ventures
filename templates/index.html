<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Startup Analyst</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
    <style>
        body { padding: 2rem; }
        .hidden { display: none; }
        .card { margin-top: 1.5rem; }
        .card-header { font-weight: bold; font-size: 1.2rem; }
        .card-body ul { margin-bottom: 0; }
    </style>
</head>
<body>
    <main class="container">
        <!-- ... (your header and form are the same) ... -->
        <header>
            <h1>ðŸ¤– AI Startup Analyst</h1>
            <p>Upload a pitch deck and website to get an instant investment memo.</p>
        </header>

        <form id="analysis-form">
            <label for="pitch_deck">Pitch Deck (PDF)</label>
            <input type="file" id="pitch_deck" name="pitch_deck" accept=".pdf" required>
            
            <label for="website_url">Website URL (Optional)</label>
            <input type="text" id="website_url" name="website_url" placeholder="e.g., www.example.com">

            <button type="submit" id="submit-btn">Analyze</button>        
        </form>
        
        <!-- Loading Indicator -->
        <div id="loading" class="hidden">
            <p id='loading-message' aria-busy="true">Submitting for analysis...</p>
        </div>
        
        <!-- Results Area -->
        <div id="results" class="hidden"></div>

    </main>

    <script>
        const form = document.getElementById('analysis-form');
        const loadingDiv = document.getElementById('loading');
        const loadingMessage = document.getElementById('loading-message');
        const resultsDiv = document.getElementById('results');
        const submitBtn = document.getElementById('submit-btn');

        let pollingInterval;

        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // Stop normal form submission
            
            // Show loading, hide old results
            submitBtn.disabled = true;
            loadingMessage.textContent = 'Uploading and submitting for analysis...';
            loadingDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');
            resultsDiv.innerHTML = ''; // Clear previous results

            const formData = new FormData(form);

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();
                if (data.task_id) {
                    loadingMessage.textContent = 'Analysis in progress. Waiting for results...';
                    // Start polling for the result
                    pollTaskStatus(data.task_id);
                } else {
                    throw new Error(data.error || 'Failed to start analysis task.');
                }

            } catch (error) {
                showError(error.message);

            } 
        });
        function pollTaskStatus(taskId) {
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/status/${taskId}`);
                    const data = await response.json();

                    if (data.state === 'SUCCESS') {
                        clearInterval(pollingInterval);
                        displayResults(data.result);
                    } else if (data.state === 'FAILURE') {
                        clearInterval(pollingInterval);
                        showError(data.status);
                    }
                    // If PENDING, just wait for the next poll
                } catch (error) {
                    clearInterval(pollingInterval);
                    showError('Lost connection while checking status.');
                }
            }, 3000); // Poll every 3 seconds
        }
        function displayResults(data) {
            if (data.error) {
                showError(data.error);
                return;
            }
            // New logic to handle combined verdict and justification
            let verdictText = data.verdict;
            let justificationText = data.justification;

            if (!justificationText && verdictText && verdictText.includes(' - ')) {
                const parts = verdictText.split(' - ');
                verdictText = parts[0].trim();
                justificationText = parts.slice(1).join(' - ').trim();
            }
            // Create and append the HTML for the results
            resultsDiv.innerHTML = `
                <h2>Analysis Complete</h2>
                <article class="card">
                    <div class="card-body"><strong>Summary:</strong> ${data.company_summary}</div>
                </article>
                <article class="card">
                    <div class="card-body"><strong>Verdict:</strong> ${data.verdict}</div>
                </article>
                <article class="card">
                    <div class="card-body"><strong>Justification:</strong> ${data.justification}</div>
                </article>
                
                <div class="grid">
                    <article class="card">
                        <div class="card-header">Strengths ðŸ’ª</div>
                        <div class="card-body">
                            <ul>${data.strengths.map(item => `<li>${item}</li>`).join('')}</ul>
                        </div>
                    </article>
                    <article class="card">
                        <div class="card-header">Weaknesses ðŸš©</div>
                        <div class="card-body">
                            <ul>${data.weaknesses.map(item => `<li>${item}</li>`).join('')}</ul>
                        </div>
                    </article>
                </div>
            `;
            loadingDiv.classList.add('hidden');
            resultsDiv.classList.remove('hidden');
            submitBtn.disabled = false
        }
        function showError(message) {
            resultsDiv.innerHTML = `<article><p><strong>Error:</strong> ${message}</p></article>`;
            loadingDiv.classList.add('hidden');
            resultsDiv.classList.remove('hidden');
            submitBtn.disabled = false;
            clearInterval(pollingInterval);
        }
    </script>
</body>
</html>